\chapter{Análisis y Desarrollo Experimental}\label{ch:analisis-y-desarrollo-experimental}
En este capítulo se recoge el estudio de técnicas del DL para el diagnóstico del Alzheimer, pasando por las 
herramientas y los datos utilizados hasta la experimentación y el análisis de los resultados obtenidos.

\section{Presentación del problema a resolver}\label{sec:presentacion-del-problema-a-resolver}
Tras la investigación del estado actual de la literatura en este ámbito, se recopilan los siguientes puntos sobre el DL
para clasificación de la EA:

\begin{itemize}
    \item El Transfer Learning es la mejor técnica de entrenamiento.
    \item Los datasets balanceados ofrecen mejores resultados, y más fiables, en la clasificación de imágenes,
    pero la limitación de disponibilidad de biomarcadores del seguimiento de la EA puede suponer un obstáculo.
    \item La prueba más frecuente para el diagnóstico de la enfermedad es la MRI.
    \item No se clarifica qué plano cerebral (axial, coronal o sagital) es mejor utilizar y bajo qué diferencias de
    rendimiento.
    \item No se realizan comparativas de rendimiento entre distinto número de clases. \\
\end{itemize}

Se propone desarrollar un sistema de aprendizaje profundo a partir de MRI con el cual:

\begin{itemize}
    \item Realizar un análisis sobre qué plano cerebral ofrece mejores resultados en el diagnóstico de la EA, ya que se
    tiene en cuenta que las redes neuronales de 3 dimensiones requieren de una capacidad computacional muy alta.
    \item Realizar una comparativa del rendimiento de la clasificación entre 2 y 3 clases: Cognitivamente normal frente 
    a Alzheimer y cognitivamente normal frente a deterioro cognitivo leve frente Alzheimer.
\end{itemize}

\section{Conjunto de datos empleado}\label{sec:conjunto-de-datos-empleado}
El conjunto de biomarcadores MRI que se ha utilizado se ha obtenido de la base de datos ADNI, que es un estudio
longitudinal multicéntrico en el que se desarrollan biomarcadores genéticos, bioquímicos y de imagen para la detección
temprana y el seguimiento de la EA, se habla más en profundidad sobre esta base de datos en el
apartado~\ref{ch:aped.a}.
Cabe destacar que también intentó hacer uso de la base de datos OASIS, de forma que se obtuviera un número mayor de
datos y poder prevenir los posibles problemas por falta de datos, pero no fue posible ya que no se aprobó la solicitud
de acceso realizada.

Para la selección de los biomarcadores MRI a utilizar se han dividido 3 grupos de investigación según el grado de EA
del sujeto, diferenciándose:
\begin{itemize}
    \item \textbf{Cognitivamente normal} (en adelante este grupo se denominará \textbf{CN}): Sujetos sanos.
    \item Sujetos con un \textbf{deterioro cognitivo leve}, del inglés Mild Cognitive Impairment (en adelante este grupo
    se denominará \textbf{MCI})
    \item Sujetos con \textbf{Alzheimer} diagnosticado (en adelante este grupo se denominará \textbf{AD}). \\
\end{itemize}

Para la realización de la experimentación se han utilizado biomarcadores MRI de tipo \textit{NIfTI} pertenecientes a un
subconjunto de datos sometidos a un post-procesamiento que se comenta en la sección~\ref{subsec:post-procesamiento-en-adni}.

En el subconjunto de datos disponibles, los biomarcadores de clase AD son más limitados que los de clase CN y MCI.
Siendo la distribución de los datos la siguiente:

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{./imgs/histograma-de-clases}
    \caption{Histograma de clases}
    \label{fig:histograma-de-clases}
\end{figure}

Como se puede apreciar en la Figura~\ref{fig:histograma-de-clases}, existe un desbalance de clases, habiendo 998
neuroimágenes de tipo CN, 1832 de tipo MCI y 602 de tipo AD.

Para realizar el entrenamiento con un datasets balanceado se utilizan todos los datos de tipo AD disponibles y se
realiza un submuestreo de las clases mayoritarias para equilibrar las clases.
El uso de la técnica de submuestreo presenta una desventaja ya que se pierde información, pero se elige esta técnica
frente a la técnica de sobremuestreo, ya que esta última consiste en aumentar los datos de la clase minoritaria, lo
que puede llevar a un sobreajuste y teniendo en cuenta que ya el conjunto de datos general del que se dispone es muy
limitado y es posible que se obtenga un sobreajuste no se quieren multiplicar las posibilidades.

De modo que el conjunto completo de datos balanceado que se utiliza para extraer los cortes axial, coronal y sagital
está formado por \textbf{1806} neuroimágenes en total.

\section{Herramientas utilizadas}\label{sec:herramientas-utilizadas}
Para realizar este estudio es necesario utilizar una serie de herramientas que faciliten y hagan posible la 
experimentación.
Hay que tener en cuenta dos grupos de herramientas: Las herramientas para trabajar con biomarcadores de tipo MRI y las 
herramientas para trabajar con técnicas de DL.

\subsection{Herramientas para trabajar con biomarcadores MRI de tipo NIfTI}
\label{subsec:herramientas-para-trabajar-con-biomarcadores-mri-de-tipo-nifti}
Para poder realizar el sistema de clasificación es necesario realizar un procesamiento de los archivos de MRI, de 
manera que se obtengan cortes de 2 dimensiones a partir del archivo en 3 dimensiones.
Para conseguirlo se ha hecho uso de la librería para python \textbf{NiBabel}, que permite la lectura y escritura  de 
archivos de neuroimagen, en nuestro caso del formato \textit{NIfTI}.
Por lo que mediante esta librería se puede cargar una MRI, extraer el corte o slice deseado y guardarlo.

Además, para la visualización de este tipo de archivos se requiere de software de visualización de imágenes específico.
Hay múltiples herramientas disponibles para ello según la finalidad que se quiera conseguir.
Para visualizar archivos en formato \textit{NIfTI} se ha hecho uso del software \textbf{MRIcron}, que ha requerido 
instalación y con el que se ha podido realizar una visualización de múltiples capas de la MRI. También se ha hecho uso 
del recurso \textbf{IDA} online del que se obtienen los datos de la base de datos \textit{ADNI} y del que se detalla más
información en el el apartado~\ref{ch:aped.a}.
Este recurso integra un visualizador de neuroimágenes.


\subsection{Herramientas para trabajar con técnicas de Deep Learning}
\label{subsec:herramientas-para-trabajar-con-tecnicas-de-deep-learning}
Como bien se muestra en el apartado~\ref{sec:datos-y-herramientas-estado-del-arte}, existe un amplio abanico de
posibilidades en cuanto a herramientas que permiten la experimentación de técnicas de DL.

De entre todas ellas se ha optado por utilizar \textbf{TensorFlow} y \textbf{Keras}, no solo por ser las más utilizadas
en la literatura, sino también porque son las que ofrecen una mejor documentación para su uso.

Para trabajar con imágenes 2D y por lo tanto con vectores y matrices se hace uso de la biblioteca de \textit{Python}
\textbf{NumPy}.

Para visualizar, tanto las imágenes de los planos cerebrales obtenidos como para la representación de las gráficas de
resultados se usa \textbf{Matplotlib}.

Por lo tanto el lenguaje de programación con el que se va a trabajar en este TFG y en concreto en el desarrollo
experimental es \textbf{Python}.

\section{Procesamiento de biomarcadores}\label{sec:procesamiento-de-biomarcadores}

\subsection{Post-procesamiento en ADNI}\label{subsec:post-procesamiento-en-adni}
Tal y como se ha comentado en ~\ref{sec:conjunto-de-datos-empleado}, el conjunto de datos utilizado en este estudio se
ha obtenido de un subconjunto de neuroimágenes de ADNI al que se le aplica un procesamiento, con el objetivo de extraer
la información más importante y descartar la irrelevante.

Para la realización de este procesamiento, al que ADNI denomina como post-procesamiento, ya que se  en una fase
posterior a la examinación del sujeto, se hace uso de la herramienta FreeSurfer y  se aplican las siguiente técnicas:

\begin{itemize}
    \item \textbf{Registro de la imagen}: proceso de transformación a un sistema de coordenadas común.
    Consiguiendo que en distintas imágenes cerebrales los pixeles correspondan en posición.
    \item \textbf{Segmentación del cráneo}: proceso de eliminación del cráneo para aislar la masa cerebral.
    \item \textbf{Normalización de la intensidad}: proceso de corrección de intensidad de la imágen.
    Se aplica N3 que es un algoritmo de afilado de picos de histograma.
\end{itemize}

En la Figura~\ref{fig:adni-mri} se puede ver una comparativa entre una MRI en bruto con MP-RAGE y la misma post-procesada con
FreeSurfer.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{./imgs/adni-mri}
    \caption{Técnicas de procesamiento de MRI en ADNI. De izquierda a derecha: MRI en bruto con MP-RAGE y MRI
    post-procesada con FreeSurfer. Fuente: Alzheimer’s Disease Neuroimaging Initiative~\cite{img-adni-mri}. }
    \label{fig:adni-mri}
\end{figure}


\subsection{Creación de las imágenes para el entrenamiento}\label{subsec:creacion-de-las-imagenes-para-el-entrenamiento}
Para evaluar qué plano cerebral ofrece mejores resultados para el diagnóstico de la EA a partir de biomarcadores MRI es
necesario obtener imágenes 2D a partir de los archivos de MRI \textit{NIfTI}.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{./imgs/planos-cerebrales}
    \caption{Planos Cerebrales. Fuente: Anatomical Planes por Casey Henley~\cite{img-planos-cerebrales}. }
    \label{fig:planos-cerebrales}
\end{figure}

Para ello mediante un script de python se leen las imágenes 3D, se generan los cortes correspondientes a los planos
usando la capa de central como corte del plano para extraer la mayor información posible y se guardan los cortes
generados en carpetas dedicadas a cada plano.

De manera que el conjunto de resonancias magnéticas del que se extraen los cortes es el mismo para los tres subconjuntos
que se obtienen.
De esta forma se garantiza que a la hora de concluir la evaluación, los cortes han surgido de las mismas resonancias
magnéticas y los resultados serán fiables.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{./imgs/MRI-planos-cerebrales}
    \caption{MRI en los planos axial, sagital y coronal.
    Fuente: Trakia Journal of Sciences~\cite{img-mri-planos-cerebrales}. }
    \label{fig:mri-planos-cerebrales}
\end{figure}

\section{Estrategias de entrenamiento}
\subsection{Transfer Learning}
\subsection{Data Augmentation}

\section{Arquitectura del modelo profundo utilizado}

\section{Experimentos}
\subsection{Comparativa del rendimiento de los planos cerebrales}

\section{Conclusión}
